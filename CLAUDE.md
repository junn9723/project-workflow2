# CLAUDE.md - AIエージェントチーム開発 ワークフロー定義

> **本プロジェクトは仕様書駆動開発(Spec-Driven Development)をAIエージェントチームで実行する。**
> 人間はマネージャーへの指示と成果物(仕様書・動作するアプリ)の評価のみを行う。

### ロール別参照ガイド
| ロール | 本ファイル | 追加で読むファイル |
|--------|-----------|------------------|
| **PM（マネージャー）** | 必読 | `.agent/playbooks/pm-playbook.md` |
| **メンバー全般** | 必読 | `.agent/playbooks/member-handbook.md` |

---

## 1. 基本原則

### 1.1 開発思想
- **仕様書駆動開発**: 仕様書が唯一の正(Single Source of Truth)
- **TDD (テスト駆動開発)**: テストを先に書き、テストをパスさせる形で実装する
- **チーム開発**: マネージャー(PM) + 専門メンバーによるチーム体制
- **品質保証**: 人への提出物は必ずテスト・検証済み
- **完全自律実行**: 不明点は自律的に推論・判断し、最後まで責任を持って開発を完遂する
- **テスト駆動文化**: E2Eテストの省略・手抜きはプロジェクト失敗に直結する重大違反。全機能はE2Eテスト合格で完成を証明する

### 1.2 人間とAIの役割分担
| 対象 | 役割 |
|------|------|
| **人間** | マネージャーへの希望伝達、成果物(仕様書・動くアプリ)の評価のみ |
| **人間が見るもの** | `docs/specs/` 内の仕様書、実際に動作するアプリケーション |
| **人間がやらないこと** | 中間成果物のレビュー、コードレビュー、タスク管理 |
| **マネージャー(PM)** | タスク分解・アサイン・進捗管理・品質管理・学習 |
| **メンバー** | 設計・実装・テスト・レビューの実行 |

### 1.3 品質と深い思考
- MVP開発における品質を左右する重要な場面では、より深い思考や分析（**think hard**, **ultrathink**）を行い品質を高める
- 重要な場面の例: アーキテクチャ設計、データモデル設計、複雑なビジネスロジック、セキュリティ設計
- 各段階で`TODO`マークを使用して作業漏れを防ぎ、確実な進捗管理を行う

### 1.4 日本語コミュニケーション
- 全ての生成ドキュメント（レポート、仕様書、ログのサマリー等）は日本語で記述する
- コード内コメントや技術的に英語が適切な箇所はこの限りではない

---

## 2. チーム構成概要

### 2.1 メンバー（実行エージェント）
本プロジェクトでは **Claude Code** と **Codex CLI** の2つのAIエージェントをメンバーとして使い分ける。

| メンバー | 強み | 適するタスク |
|---------|------|------------|
| **Claude Code** | クリエイティブ、UIデザイン、発想力、柔軟性 | UI設計・フロントエンド実装、初期仕様の発想、軽微な修正、E2Eテスト(Playwright MCP) |
| **Codex CLI** | 仕様準拠の確実な実装、コードレビュー、大規模作業 | バックエンド実装、データモデル設計、仕様/コードレビュー、大規模リファクタリング |

### 2.2 ロール一覧
詳細は `.agent/config/roles.yml` を参照。

| ロール | 責務 | タスク実行 |
|--------|------|-----------|
| **PM (マネージャー)** | 全体統括・タスク管理・品質管理 | **自らタスク実行しない** |
| **Architect (設計者)** | システム設計・仕様書作成 | 設計タスク |
| **Developer (実装者)** | コーディング・ユニットテスト | 実装タスク |
| **Reviewer (レビュアー)** | 設計レビュー・コードレビュー | レビュータスク |
| **Tester (テスター)** | 結合テスト・E2Eテスト | テストタスク |

---

## 3. 開発フロー概要

```
[人間] inbox/ に仕様書を配置
  ↓
[PM] inbox/ を検知・読み込み
  ↓
=== Phase 1: 仕様策定 ===
[PM → Architect] 要求分析 → 仕様書作成 → 技術設計 → タスク分解
[PM → Reviewer]  仕様書レビュー → APPROVED
  ↓
=== Phase 2: 実装 ===
[PM → Developer] TDDで実装 → セルフレビュー → ユニットテスト全パス
[PM → Developer] 開発完了レポート作成
  ↓
=== Phase 3 & 4: 自律テスト-修正ループ ===
[PM → Tester]    E2Eテスト計画策定 → テスト実行
  ↓ 全パス → Phase 5 へ
  ↓ 不合格 → [PM → Developer] 修正 → Phase 3 再実行
  (全テスト合格まで自動反復。人間の介入不要)
  ↓
=== Phase 5: 最終報告 ===
[PM] 最終報告書作成 → 人間に提出
[PM] 元の仕様書を inbox/processed/ に移動
```

- **Phase 1**: Architect が仕様書を作成し、Reviewer がレビュー
- **Phase 2**: Developer が TDD で実装し、開発完了レポートを作成
- **Phase 3&4**: Tester が E2E テストを実施。不合格なら Developer が修正し再テスト（最大5ループ）
- **Phase 5**: PM が最終報告書を作成し人間に提出

> 各 Phase の詳細手順: PM → `pm-playbook.md` / メンバー → `member-handbook.md`

---

## 4. TDD (テスト駆動開発) ルール

### 4.1 開発サイクル
1. **RED**: 失敗するテストを先に書く
2. **GREEN**: テストをパスする最小限の実装を書く
3. **REFACTOR**: コードを整理する（テストは常にグリーン維持）

### 4.2 テスト構成
```
tests/
├── unit/          # ユニットテスト (各モジュール単位)
├── integration/   # 結合テスト (モジュール間連携)
└── e2e/
    └── playwright/ # E2Eテスト (Playwright MCP使用)
```

### 4.3 テスト実行ルール
- 実装者はユニットテストを書いてパスさせる
- テスターは結合テスト・E2Eテストを実行する
- E2Eテストには **Playwright MCP** を使用する
- テスト合格を持って実装完了とする
- **E2Eテスト省略は禁止** — 全機能は網羅的なE2Eテストで完成を証明する

---

## 5. ワークスペース (claude_workspace)

### 5.1 役割
`claude_workspace/` は開発プロセスの全中間成果物・ログ・レポート・エビデンスを保存する共有ディレクトリ。
どのエージェントでも現在の状況を即座に理解し、作業を引き継げるようにする。

### 5.2 構成
```
claude_workspace/
├── development-completion-report.md   # Phase 2 完了レポート
├── e2e-test-plan.md                   # E2Eテスト計画（毎ループ更新）
├── e2e-test-result.md                 # E2Eテスト結果（毎ループ更新）
├── correction-report.md               # 修正レポート（毎ループ更新）
└── downloads/                         # エビデンス格納
    ├── screenshots/                   # Playwright スクリーンショット
    ├── logs/                          # テスト実行ログ・コンソールログ
    └── loop-N/                        # ループN回目のアーカイブ
```

### 5.3 エビデンス管理ルール
- テスト実行時のコンソールログ、スクリーンショット等は必ず `claude_workspace/downloads/` に保存する
- 各ループの成果物はループ番号付きディレクトリ (`loop-1/`, `loop-2/`, ...) にアーカイブする
- レポートからエビデンスファイルへの相対パスで参照できるようにする
- エラーログがある場合は必ず確認し、見逃しがないようにする

---

## 6. 仕様書管理

### 6.1 仕様書の位置づけ
- 仕様書は **人間が参照する唯一のドキュメント**
- コードベースを読まなくても全体像を把握できる品質を維持
- `docs/specs/` に格納

### 6.2 仕様書構成
```
docs/
├── specs/          # 機能仕様書 (人間が参照)
│   ├── requirements.md  # 要求仕様書
│   └── design.md        # 技術設計書
├── architecture/   # アーキテクチャ文書
└── decisions/      # ADR (Architecture Decision Records)
```

### 6.3 仕様書テンプレート
- `.agent/templates/spec.md` を使用
- いつでも・どこでも・誰でも同じ知見を共有できる粒度で記述
- **最終報告前に、仕様書が実装と一致しているか必ず確認・更新する**

---

## 7. 知識共有 (ナレッジベース)

### 7.1 共有知識の管理
場所・時間・エージェント間で知見を共有するための仕組み。

```
.agent/knowledge/
├── lessons-learned.md  # 失敗と学びの記録
├── patterns.md         # 検証済みパターン集
└── conventions.md      # コーディング規約・命名規則
```

### 7.2 知見共有ルール
- タスク着手前に `.agent/knowledge/` を確認すること
- 新しい知見を得たら即座に記録すること
- 仕様変更時は関連する全ドキュメントを更新すること

---

## 8. ツール・MCP カタログ

### 8.1 標準ツール
詳細は `.agent/config/tools.yml` を参照。

| ツール | 用途 | 利用場面 |
|--------|------|---------|
| **Claude Code** | メイン開発環境 | 全工程 |
| **Codex CLI** | コード生成・解析 | 実装・リファクタリング |
| **Playwright MCP** | E2Eテスト | テスト工程 |
| **Context7 MCP** | ライブラリドキュメント参照 | 実装・調査 |
| **o3-search MCP** | Web検索 | 調査・トラブルシューティング |

### 8.2 Claude Code Skills (標準装備)
| Skill | 用途 |
|-------|------|
| `/build` | プロジェクトビルド |
| `/test` | テスト実行 |
| `/analyze` | コード分析 |
| `/scan` | セキュリティスキャン |
| `/troubleshoot` | デバッグ・問題解決 |
| `/design` | システム設計 |
| `/improve` | コード改善 |
| `/explain` | 技術ドキュメント |
| `/git` | Git操作 |
| `/deploy` | デプロイ |
| `/migrate` | マイグレーション |
| `/document` | ドキュメント生成 |
| `/estimate` | 工数見積もり |
| `/task` | タスク管理 |
| `/spawn` | 並列エージェント起動 |
| `/load` | プロジェクトコンテキスト読み込み |

---

## 9. ディレクトリ構成

```
project-workflow2/
├── CLAUDE.md                    # 本ファイル (プロジェクト共通ルール)
├── FINAL_MVP_REPORT.md          # 最終報告書 (Phase 5 で生成)
├── inbox/                       # ユーザー初期仕様書 受付（ここに置くだけ）
│   └── processed/               # 処理済みの元ファイル
├── claude_workspace/            # 中間成果物・エビデンス
│   ├── development-completion-report.md
│   ├── e2e-test-plan.md
│   ├── e2e-test-result.md
│   ├── correction-report.md
│   └── downloads/               # スクリーンショット・ログ等
│       ├── screenshots/
│       ├── logs/
│       └── loop-N/              # ループN回目のアーカイブ
├── .claude/
│   └── commands/                # カスタムスラッシュコマンド
├── docs/
│   ├── specs/                   # 機能仕様書 (人間向け)
│   │   ├── requirements.md      # 要求仕様書
│   │   └── design.md            # 技術設計書
│   ├── architecture/            # アーキテクチャ文書
│   └── decisions/               # ADR
├── .agent/
│   ├── playbooks/
│   │   ├── pm-playbook.md       # PM専用プレイブック
│   │   └── member-handbook.md   # メンバー共通ハンドブック
│   ├── config/
│   │   ├── team.yml             # チーム構成定義
│   │   ├── workflow.yml         # ワークフロールール
│   │   ├── tools.yml            # ツール・MCPカタログ
│   │   └── roles.yml            # ロール定義
│   ├── tasks/                   # タスクファイル (エージェント間連携)
│   ├── reviews/                 # レビュー・テスト記録
│   ├── knowledge/
│   │   ├── lessons-learned.md   # 失敗と学びの記録
│   │   ├── patterns.md          # 検証済みパターン
│   │   └── conventions.md       # コーディング規約
│   ├── templates/
│   │   ├── task.md              # タスクテンプレート
│   │   ├── spec.md              # 仕様書テンプレート
│   │   ├── review.md            # レビューテンプレート
│   │   └── test-report.md       # テストレポートテンプレート
│   └── logs/                    # 実行ログ
├── app/                         # アプリケーションコード
├── tests/
│   ├── unit/                    # ユニットテスト
│   ├── integration/             # 結合テスト
│   └── e2e/
│       └── playwright/          # E2Eテスト
└── scripts/                     # ユーティリティスクリプト
```

---

## 10. Git バージョン管理

### 10.1 コミットのタイミング
- 新機能の実装完了時
- バグ修正完了時
- 設定ファイルの変更時
- リファクタリング完了時
- テストの追加・修正時
- **大規模な変更の前に、現在の状態を必ずコミットする**

### 10.2 コミットメッセージ
```
<種別>: <変更内容の要約>

<詳細説明（任意）>

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```
種別: `feat` / `fix` / `style` / `refactor` / `test` / `docs` / `chore`

### 10.3 禁止事項
- `git push --force` は禁止
- `main` ブランチへの直接の破壊的変更は禁止
