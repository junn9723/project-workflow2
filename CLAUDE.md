# CLAUDE.md - AIエージェントチーム開発 ワークフロー定義

> **本プロジェクトは仕様書駆動開発(Spec-Driven Development)をAIエージェントチームで実行する。**
> 人間はマネージャーへの指示と成果物(仕様書・動作するアプリ)の評価のみを行う。

---

## 1. 基本原則

### 1.1 開発思想
- **仕様書駆動開発**: 仕様書が唯一の正(Single Source of Truth)
- **TDD (テスト駆動開発)**: テストを先に書き、テストをパスさせる形で実装する
- **チーム開発**: マネージャー(PM) + 専門メンバーによるチーム体制
- **品質保証**: 人への提出物は必ずテスト・検証済み
- **完全自律実行**: 不明点は自律的に推論・判断し、最後まで責任を持って開発を完遂する
- **テスト駆動文化**: E2Eテストの省略・手抜きはプロジェクト失敗に直結する重大違反。全機能はE2Eテスト合格で完成を証明する

### 1.2 人間とAIの役割分担
| 対象 | 役割 |
|------|------|
| **人間** | マネージャーへの希望伝達、成果物(仕様書・動くアプリ)の評価のみ |
| **人間が見るもの** | `docs/specs/` 内の仕様書、実際に動作するアプリケーション |
| **人間がやらないこと** | 中間成果物のレビュー、コードレビュー、タスク管理 |
| **マネージャー(PM)** | タスク分解・アサイン・進捗管理・品質管理・学習 |
| **メンバー** | 設計・実装・テスト・レビューの実行 |

### 1.3 品質と深い思考
- MVP開発における品質を左右する重要な場面では、より深い思考や分析（**think hard**, **ultrathink**）を行い品質を高める
- 重要な場面の例: アーキテクチャ設計、データモデル設計、複雑なビジネスロジック、セキュリティ設計
- 各段階で`TODO`マークを使用して作業漏れを防ぎ、確実な進捗管理を行う

### 1.4 日本語コミュニケーション
- 全ての生成ドキュメント（レポート、仕様書、ログのサマリー等）は日本語で記述する
- コード内コメントや技術的に英語が適切な箇所はこの限りではない

---

## 2. チーム構成とロール

### 2.1 メンバー（実行エージェント）
本プロジェクトでは **Claude Code** と **Codex CLI** の2つのAIエージェントをメンバーとして使い分ける。

| メンバー | 強み | 適するタスク |
|---------|------|------------|
| **Claude Code** | クリエイティブ、UIデザイン、発想力、柔軟性 | UI設計・フロントエンド実装、初期仕様の発想、軽微な修正、E2Eテスト(Playwright MCP) |
| **Codex CLI** | 仕様準拠の確実な実装、コードレビュー、大規模作業 | バックエンド実装、データモデル設計、仕様/コードレビュー、大規模リファクタリング |

### 2.2 アサインマトリクス（PMが参照）
| ロール | 推奨メンバー | 理由 |
|--------|------------|------|
| **Architect (設計)** | Claude Code | 初期仕様の発想力・柔軟なUI設計 |
| **Developer (バックエンド)** | Codex CLI | 明確な要件に対する確実な実装 |
| **Developer (フロントエンド)** | Claude Code | UIデザイン・クリエイティブな実装 |
| **Developer (大規模実装)** | Codex CLI | 大量コードの一貫した生成 |
| **Developer (軽微な修正)** | Claude Code | 柔軟で迅速な対応 |
| **Reviewer (仕様レビュー)** | Codex CLI | 仕様との厳密な整合性チェック |
| **Reviewer (コードレビュー)** | Codex CLI | 体系的なコード品質検証 |
| **Tester (E2Eテスト)** | Claude Code | Playwright MCP による柔軟なテスト |
| **Tester (テスト計画)** | Codex CLI | 網羅的で体系的な計画策定 |
| **Phase 4 修正** | Codex CLI | 不具合の根本原因特定と確実な修正 |

> **注**: 上記は推奨。PMはタスクの性質を見て最適なメンバーを判断する。

### 2.3 ロール定義
詳細は `.agent/config/roles.yml` を参照。

| ロール | 責務 | タスク実行 |
|--------|------|-----------|
| **PM (マネージャー)** | 全体統括・タスク管理・品質管理 | **自らタスク実行しない** |
| **Architect (設計者)** | システム設計・仕様書作成 | 設計タスク |
| **Developer (実装者)** | コーディング・ユニットテスト | 実装タスク |
| **Reviewer (レビュアー)** | 設計レビュー・コードレビュー | レビュータスク |
| **Tester (テスター)** | 結合テスト・E2Eテスト | テストタスク |

### 2.4 重要ルール
- **PM は自らタスク実行を行わない** (管理・判断・学習に専念)
  - コード編集、テスト実行、DB操作、Git操作、デバッグは全て禁止（詳細は10.1参照）
  - 「小さな修正」「緊急対応」であっても例外なくメンバーにアサインする
  - 違反した場合は lessons-learned.md に記録し再発を防止する
- **設計は担当者以外のレビュアーが必ずレビューしてからFIX**
- **実装は必ずテスターによるテストを経て完了**
- **不合格3回で PM に差し戻し → 別担当者をアサイン（別メンバーへの切替も検討）**
- **タスクファイルは自己完結的に記述し、どのメンバーでも単独で作業開始できるようにする**
- **PMは作業を委任する前に、必ず `.agent/tasks/` にタスクファイルを作成すること**
  - タスクファイルなしでサブエージェントに直接委任することは禁止
  - 口頭指示やプロンプトのみでの委任は作業の追跡・再現が不可能になるため厳禁
  - タスクファイルを先に作成 → タスクファイルのパスを指定してサブエージェントを起動する
- **全ての実装・修正タスクには Tester による検証を必ず含めること**
  - 軽微な修正（1行変更、設定値の変更等）であっても Tester による検証を省略しない
  - Developer へのアサイン時に、テスト担当者も併せてタスクファイルに記載する
  - 「影響範囲が小さいからテスト不要」という判断は禁止 — 小さな変更こそ見落としが発生しやすい

### 2.5 チーム編成とメンバー起動方法

> **タスクを実行する際は、エージェントチームズ機能（TeamCreate）を用いて必ず2名以上のチームメイトを生成する。**
> PM（マネージャー）はタスク分解・指示・進捗管理・最終統合に専念し、自らコードを書かない。

#### チーム運用の基本ルール
1. **TeamCreate** でチームを作成し、**Task** ツール（`team_name` 付き）でチームメイトを生成する
2. チームメイトは `general-purpose` サブエージェント（Claude Code）として起動する
3. Codex CLI を使う場合は、**チームメイトが Bash ツールで `codex exec` を実行する**（PMが直接実行しない）
4. チームメイト間の連携は **SendMessage** と **TaskList/TaskUpdate** で行う
5. 全作業完了後、PM が **shutdown_request** で全チームメイトを終了し **TeamDelete** でクリーンアップする

#### チーム編成パターン

**パターン A: 標準的な機能開発・ホットフィックス（2名）**
```
PM（マネージャー）
├── developer: 実装担当（Claude Code）
└── tester: レビュー＋テスト担当（Claude Code）
```

**パターン B: 中規模開発（3〜4名）**
```
PM（マネージャー）
├── developer-frontend: フロントエンド実装（Claude Code）
├── developer-backend: バックエンド実装（Claude Code）
├── reviewer: コードレビュー（Claude Code → Codex CLI で実行）
└── tester: E2Eテスト担当（Claude Code + Playwright MCP）
```

**パターン C: 複雑なリファクタリング（3名〜）**
```
PM（マネージャー）
├── analyst: 調査・設計担当（Claude Code → Codex CLI で影響範囲分析）
├── developer: リファクタ実行担当（Claude Code）
└── tester: テスト＋回帰確認担当（Claude Code + Playwright MCP）
```

> **注**: PMはタスクの規模・性質に応じて最適なパターンと人数を判断する。

#### Codex CLI 起動テンプレート（チームメイトが Bash で実行）
```bash
codex exec --full-auto \
  "以下のタスクを実行してください。
   まず以下のファイルを読み込んでください:
   1. CLAUDE.md
   2. .agent/config/roles.yml
   3. .agent/knowledge/lessons-learned.md
   4. .agent/knowledge/conventions.md
   5. [該当タスクファイルのパス]
   6. [該当仕様書のパス]

   あなたのロール: [ロール名]
   タスク: [タスク概要]
   完了したらタスクファイルのステータスを更新してください。"
```

---

## 3. ワークフロー

### 3.0 inbox 起点の MVP 開発フロー
人間は `inbox/` に仕様書を置くだけ。PMが検知して自動的にMVP開発を開始する。

```
[人間] inbox/ に仕様書を配置
  ↓
[PM] inbox/ を検知・読み込み
  ↓
=== Phase 1: 仕様策定 ===
[PM → Architect] 要求分析 → 仕様書作成 → 技術設計 → タスク分解
[PM → Reviewer]  仕様書レビュー → APPROVED
  ↓
=== Phase 2: 実装 ===
[PM → Developer] TDDで実装 → セルフレビュー → ユニットテスト全パス
[PM → Developer] 開発完了レポート作成
  ↓
=== Phase 3 & 4: 自律テスト-修正ループ ===
[PM → Tester]    E2Eテスト計画策定 → テスト実行
  ↓ 全パス → Phase 5 へ
  ↓ 不合格 → [PM → Developer] 修正 → Phase 3 再実行
  (全テスト合格まで自動反復。人間の介入不要)
  ↓
=== Phase 5: 最終報告 ===
[PM] 最終報告書作成 → 人間に提出
[PM] 元の仕様書を inbox/processed/ に移動
```

**inbox 処理ルール:**
1. PMは起動時に `inbox/` 内のファイル（README.md, processed/ を除く）を確認する
2. 未処理ファイルがあれば、すべて読み込み内容を把握する
3. MVP（最小限の動作する製品）のスコープを決定する
4. Phase 1 → 2 → 3&4 → 5 の順でフェーズ制で開発を進行する
5. 処理済みの元ファイルは `inbox/processed/` に移動する
6. 仕様書が曖昧な場合、PMは人間に質問せず **最も妥当な解釈** で進める（人間は成果物で判断する）

---

### 3.1 Phase 1: 仕様策定

**担当**: Architect (サブエージェント) + Reviewer (サブエージェント)
**目的**: 要件定義から設計、タスク一覧まで、第三者が見ても分かりやすい正確な仕様書を作成する。

#### STEP 1: 要求仕様 (Requirements)
- **[TODO]** inbox/ のユーザー要件を分析し、必要に応じてWeb検索で類似サービスを調査する
- **[TODO]** ベストプラクティス（UI/UX、機能セット）を設計の基礎とする
- **[TODO]** 以下を含む要求仕様書を `docs/specs/requirements.md` に作成:
  - ペルソナ設定
  - コア機能（3〜5つ）
  - ユーザーストーリー
  - 画面一覧と画面遷移図（Mermaid記法）
  - 画面別機能要件

#### STEP 2: 技術設計 (Design)
- **[TODO]** 要求仕様に基づき `docs/specs/design.md` を作成:
  - データベース設計（ER図 Mermaid記法）
  - API設計（エンドポイント、メソッド、リクエスト/レスポンス）
  - ディレクトリ構成設計

#### STEP 3: 実装タスク一覧 (Tasks)
- **[TODO]** 設計に基づきPhase 2で実行する全開発ステップを `.agent/tasks/` にチェックリスト形式で作成
- **[TODO]** Reviewer による仕様書レビュー → APPROVED

**Phase 1 成果物:**
- `docs/specs/requirements.md`
- `docs/specs/design.md`
- `.agent/tasks/` にタスクファイル群
- `.agent/reviews/` にレビュー記録

---

### 3.2 Phase 2: 実装

**担当**: Developer (サブエージェント)
**目的**: TDDでアプリケーションを構築し、ユニットテスト全パスまで完了させる。

#### 実装ステップ（技術スタック非依存）
- **[TODO]** データモデル/スキーマの実装
- **[TODO]** API/バックエンドロジックの実装
- **[TODO]** ユニットテスト/フィーチャーテストの作成と全パス確認
- **[TODO]** フロントエンド/UIの実装
- **[TODO]** E2E初期検証（開発者自身による基本動作確認）
- **[TODO]** セルフレビューと修正

#### 開発完了レポート
- **[TODO]** 実装完了時に `claude_workspace/development-completion-report.md` を作成:
  - 実装した機能一覧
  - アプリケーションのアクセス情報（URL、テスト用アカウント等）
  - 既知の問題点
  - テスト結果サマリー
- **[TODO]** このレポート作成後、**自動的にPhase 3に移行する。人間の介入は不要。**

**Phase 2 成果物:**
- `app/` にアプリケーションコード
- `tests/unit/` にユニットテスト
- `claude_workspace/development-completion-report.md`

---

### 3.3 Phase 3 & 4: 自律テスト-修正ループ

> **全てのE2Eテストが合格するまで、人間の介入なしにテストと修正を自動的に繰り返す。**
> これは過去の開発で最も効果的だった仕組みであり、本フレームワークの核心である。

```
┌─── Phase 3: テスト ───┐
│ STEP A: テスト計画策定  │
│ STEP B: テスト実行     │
│ → 全パス → Phase 5 へ  │
│ → 不合格 ↓            │
└────────────────────────┘
         ↓
┌─── Phase 4: 修正 ─────┐
│ 不具合の根本原因特定    │
│ 修正実装               │
│ 修正レポート作成        │
│ → Phase 3 を再実行 ↑   │
└────────────────────────┘
```

#### Phase 3: 独立E2Eテスト

**担当**: Tester (サブエージェント) — 実装者とは別のエージェント
**目的**: 第三者の視点から網羅的なE2Eテストを実施し、品質を検証する。

##### STEP A: E2Eテスト計画の策定
- **[Input]** `development-completion-report.md`, `docs/specs/requirements.md`, `docs/specs/design.md`
- **[Output]** `claude_workspace/e2e-test-plan.md`
- **[TODO]** **ループ再実行時にも、ゼロベースでテスト計画を再策定する**（前回の修正を反映した新鮮な視点）
- **[TODO]** ルーティング定義を元に全機能を一覧し、漏れなくテスト対象に含める
- **[TODO]** まず各機能の正常系が動作するか検証し、Internal Server Error等の基本的な実装漏れがないことを担保する
- **[TODO]** ユーザーストーリーを網羅する詳細なテストシナリオ（正常系、準正常系、異常系）を策定する

##### STEP B: E2Eテストの実行と結果報告
- **[Input]** `e2e-test-plan.md`
- **[Output]** `claude_workspace/e2e-test-result.md`
- **[TODO]** Playwright MCPを用いてテストを体系的に実行する
- **[TODO]** テスト結果のサマリーを `claude_workspace/e2e-test-result.md` に記録する
- **[TODO]** エビデンス（スクリーンショット、コンソールログ、動画等）を `claude_workspace/downloads/` に保存し、レポートから参照できるようにする
- **[TODO]** 不合格項目は**具体的な再現手順、期待される挙動、実際のエラー内容**を明記する
- **[TODO]** 【ループ分岐】
  - **全テスト成功** → ループ終了、Phase 5 へ移行
  - **不合格あり** → Phase 4（修正フェーズ）へ自動移行

#### Phase 4: 修正フェーズ

**担当**: Developer (サブエージェント)
**目的**: テストで報告された不具合を修正する。

- **[Input]** `claude_workspace/e2e-test-result.md`
- **[Output]** `claude_workspace/correction-report.md`
- **[TODO]** テスト結果レポートを詳細に分析し、不具合の**根本原因**を特定する
- **[TODO]** 報告された全ての不具合を修正する
- **[TODO]** 修正内容と影響範囲を `claude_workspace/correction-report.md` に記録する
- **[TODO]** 修正完了後、**自動的にPhase 3 (STEP A〜B) を再実行する**

#### ループ上限と差し戻し
- テスト-修正ループの上限: **5回**
- 5回ループしても全テスト合格しない場合 → PMに差し戻し、根本的な問題を分析
- 各ループの記録は `claude_workspace/downloads/` にループ番号付きで保存

---

### 3.4 Phase 5: 最終報告

**担当**: PM
**目的**: 全テスト合格した最終成果物を人間に報告する。

- **[TODO]** `FINAL_MVP_REPORT.md` をプロジェクトルートに作成:
  - 開発したアプリケーションの概要・機能一覧
  - アクセス方法（URL、テスト用アカウント）
  - 全テスト合格の証跡（最終テストレポートへのリンク）
  - サンプルデータの状態説明
- **[TODO]** 動作確認用アカウントとサンプルデータが準備された状態にする
- **[TODO]** 仕様書（`docs/specs/`）が最終実装と一致していることを確認・更新する
- **[TODO]** 元の inbox ファイルを `inbox/processed/` に移動する
- **[TODO]** このレポートをもって全自律開発プロセス完了を宣言する

---

### 3.9 ホットフィックスフロー（リリース後のバグ修正）

> **Phase 5完了後やリリース後に人間からバグ報告・改善要望を受けた場合のフロー。**
> **PMが直接修正することは絶対に禁止。必ず以下のフローに従う。**

```
[人間] バグ報告・改善要望
  ↓
[PM] 問題を分析 → ホットフィックスタスクを .agent/tasks/ に作成
  ↓
[PM] TeamCreate でホットフィックスチームを編成（最低2名: developer + tester）
  ↓
[PM] TaskCreate でチームタスクを作成 → チームメイトにアサイン
  ↓
[developer] 修正を実装 → SendMessage で PM に報告
  ↓
[tester] 修正の検証（E2Eテストまたは手動検証） → SendMessage で PM に報告
  ↓
[PM] 結果確認 → shutdown_request → TeamDelete → Git コミット・プッシュ
  ↓
[PM] 人間に修正完了を報告
```

#### ホットフィックスタスクの作成ルール
- タスクファイル名: `HOTFIX-NNN.md`（連番）
- **必ず以下を含める:**
  - 人間からの報告内容（原文）
  - 再現手順（PMが推定）
  - 修正方針の概要（PMが判断、詳細は Developer に委ねる）
  - 検証基準（何をもって修正完了とするか）
- **軽微な修正（1ファイル変更程度）でも省略しない**
- PMが「自分でやった方が早い」と感じても、必ずこのフローに従う

---

### 3.5 タスクライフサイクル（個別タスク単位）
```
[PM] タスク作成 → アサイン
  ↓
[担当者] 実行 → セルフレビュー → セルフテスト
  ↓
[レビュアー] 設計レビュー (設計タスクの場合)
  ↓ 合格
[担当者] 実装
  ↓
[担当者] セルフレビュー → ユニットテスト
  ↓
[テスター] テスト実行
  ↓ 合格 → 完了
  ↓ 不合格 → 担当者に差し戻し (3回不合格 → PM差し戻し → 再アサイン)
```

### 3.6 タスクファイルによるエージェント間連携
- タスクは `.agent/tasks/` にMarkdownファイルとして管理
- テンプレート: `.agent/templates/task.md`
- ステータス: `CREATED` → `IN_PROGRESS` → `SELF_REVIEW` → `IN_REVIEW` → `TESTING` → `DONE` / `REJECTED`
- 差し戻し回数はタスクファイル内で追跡

### 3.7 レビューフロー
- レビュー記録: `.agent/reviews/` に保存
- テンプレート: `.agent/templates/review.md`
- 設計レビューは **担当者以外** が実施すること

### 3.8 テストフロー
- テスト結果: `.agent/reviews/` にテストレポートとして保存
- テンプレート: `.agent/templates/test-report.md`
- テスト不合格時は具体的な失敗理由と再現手順を記録

---

## 4. TDD (テスト駆動開発) ルール

### 4.1 開発サイクル
1. **RED**: 失敗するテストを先に書く
2. **GREEN**: テストをパスする最小限の実装を書く
3. **REFACTOR**: コードを整理する（テストは常にグリーン維持）

### 4.2 テスト構成
```
tests/
├── unit/          # ユニットテスト (各モジュール単位)
├── integration/   # 結合テスト (モジュール間連携)
└── e2e/
    └── playwright/ # E2Eテスト (Playwright MCP使用)
```

### 4.3 テスト実行ルール
- 実装者はユニットテストを書いてパスさせる
- テスターは結合テスト・E2Eテストを実行する
- E2Eテストには **Playwright MCP** を使用する
- テスト合格を持って実装完了とする
- **E2Eテスト省略は禁止** — 全機能は網羅的なE2Eテストで完成を証明する

---

## 5. ワークスペース (claude_workspace)

### 5.1 役割
`claude_workspace/` は開発プロセスの全中間成果物・ログ・レポート・エビデンスを保存する共有ディレクトリ。
どのエージェントでも現在の状況を即座に理解し、作業を引き継げるようにする。

### 5.2 構成
```
claude_workspace/
├── development-completion-report.md   # Phase 2 完了レポート
├── e2e-test-plan.md                   # E2Eテスト計画（毎ループ更新）
├── e2e-test-result.md                 # E2Eテスト結果（毎ループ更新）
├── correction-report.md               # 修正レポート（毎ループ更新）
└── downloads/                         # エビデンス格納
    ├── screenshots/                   # Playwright スクリーンショット
    ├── logs/                          # テスト実行ログ・コンソールログ
    └── loop-N/                        # ループN回目のアーカイブ
```

### 5.3 エビデンス管理ルール
- テスト実行時のコンソールログ、スクリーンショット等は必ず `claude_workspace/downloads/` に保存する
- 各ループの成果物はループ番号付きディレクトリ (`loop-1/`, `loop-2/`, ...) にアーカイブする
- レポートからエビデンスファイルへの相対パスで参照できるようにする
- エラーログがある場合は必ず確認し、見逃しがないようにする

---

## 6. 仕様書管理

### 6.1 仕様書の位置づけ
- 仕様書は **人間が参照する唯一のドキュメント**
- コードベースを読まなくても全体像を把握できる品質を維持
- `docs/specs/` に格納

### 6.2 仕様書構成
```
docs/
├── specs/          # 機能仕様書 (人間が参照)
│   ├── requirements.md  # 要求仕様書
│   └── design.md        # 技術設計書
├── architecture/   # アーキテクチャ文書
└── decisions/      # ADR (Architecture Decision Records)
```

### 6.3 仕様書テンプレート
- `.agent/templates/spec.md` を使用
- いつでも・どこでも・誰でも同じ知見を共有できる粒度で記述
- **最終報告前に、仕様書が実装と一致しているか必ず確認・更新する**

---

## 7. 知識共有 (ナレッジベース)

### 7.1 共有知識の管理
場所・時間・エージェント間で知見を共有するための仕組み。

```
.agent/knowledge/
├── lessons-learned.md  # 失敗と学びの記録
├── patterns.md         # 検証済みパターン集
└── conventions.md      # コーディング規約・命名規則
```

### 7.2 学習サイクル (PM の責務)
1. **失敗記録**: テスト不合格・レビュー指摘をすべて記録
2. **原因分析**: 根本原因を特定
3. **対策策定**: 再発防止策を `lessons-learned.md` に追記
4. **知見展開**: 全エージェントが参照できる形で共有
5. **同じミスを繰り返さない**: タスク着手前に lessons-learned を確認

### 7.3 知見共有ルール
- タスク着手前に `.agent/knowledge/` を確認すること
- 新しい知見を得たら即座に記録すること
- 仕様変更時は関連する全ドキュメントを更新すること
- **テスト-修正ループで発見された問題は、ループ終了後にPMが必ず lessons-learned に集約する**

---

## 8. ツール・MCP カタログ

### 8.1 標準ツール
詳細は `.agent/config/tools.yml` を参照。

| ツール | 用途 | 利用場面 |
|--------|------|---------|
| **Claude Code** | メイン開発環境 | 全工程 |
| **Codex CLI** | コード生成・解析 | 実装・リファクタリング |
| **Playwright MCP** | E2Eテスト | テスト工程 |
| **Context7 MCP** | ライブラリドキュメント参照 | 実装・調査 |
| **o3-search MCP** | Web検索 | 調査・トラブルシューティング |

### 8.2 Claude Code Skills (標準装備)
| Skill | 用途 |
|-------|------|
| `/build` | プロジェクトビルド |
| `/test` | テスト実行 |
| `/analyze` | コード分析 |
| `/scan` | セキュリティスキャン |
| `/troubleshoot` | デバッグ・問題解決 |
| `/design` | システム設計 |
| `/improve` | コード改善 |
| `/explain` | 技術ドキュメント |
| `/git` | Git操作 |
| `/deploy` | デプロイ |
| `/migrate` | マイグレーション |
| `/document` | ドキュメント生成 |
| `/estimate` | 工数見積もり |
| `/task` | タスク管理 |
| `/spawn` | 並列エージェント起動 |
| `/load` | プロジェクトコンテキスト読み込み |

---

## 9. ディレクトリ構成

```
project-workflow2/
├── CLAUDE.md                    # 本ファイル (プロジェクトルール)
├── FINAL_MVP_REPORT.md          # 最終報告書 (Phase 5 で生成)
├── inbox/                       # ユーザー初期仕様書 受付（ここに置くだけ）
│   └── processed/               # 処理済みの元ファイル
├── claude_workspace/            # 中間成果物・エビデンス
│   ├── development-completion-report.md
│   ├── e2e-test-plan.md
│   ├── e2e-test-result.md
│   ├── correction-report.md
│   └── downloads/               # スクリーンショット・ログ等
│       ├── screenshots/
│       ├── logs/
│       └── loop-N/              # ループN回目のアーカイブ
├── .claude/
│   └── commands/                # カスタムスラッシュコマンド
├── docs/
│   ├── specs/                   # 機能仕様書 (人間向け)
│   │   ├── requirements.md      # 要求仕様書
│   │   └── design.md            # 技術設計書
│   ├── architecture/            # アーキテクチャ文書
│   └── decisions/               # ADR
├── .agent/
│   ├── config/
│   │   ├── team.yml             # チーム構成定義
│   │   ├── workflow.yml         # ワークフロールール
│   │   ├── tools.yml            # ツール・MCPカタログ
│   │   └── roles.yml            # ロール定義
│   ├── tasks/                   # タスクファイル (エージェント間連携)
│   ├── reviews/                 # レビュー・テスト記録
│   ├── knowledge/
│   │   ├── lessons-learned.md   # 失敗と学びの記録
│   │   ├── patterns.md          # 検証済みパターン
│   │   └── conventions.md       # コーディング規約
│   ├── templates/
│   │   ├── task.md              # タスクテンプレート
│   │   ├── spec.md              # 仕様書テンプレート
│   │   ├── review.md            # レビューテンプレート
│   │   └── test-report.md       # テストレポートテンプレート
│   └── logs/                    # 実行ログ
├── app/                         # アプリケーションコード
├── tests/
│   ├── unit/                    # ユニットテスト
│   ├── integration/             # 結合テスト
│   └── e2e/
│       └── playwright/          # E2Eテスト
└── scripts/                     # ユーティリティスクリプト
```

---

## 10. エージェント実行ルール

### 10.1 PM (マネージャー) の行動規範

#### PMがやること（MUST）
1. 人間からの要望を受けてタスクを分解する
2. `.agent/knowledge/lessons-learned.md` を確認し過去の学びを反映する
3. 適切なロールにタスクをアサインする
4. `.agent/tasks/` にタスクファイルを作成する
5. **Phase 1→2→3&4→5 のフェーズ進行を管理する**
6. **Phase 3&4 の自律テスト-修正ループを監視し、ループ上限(5回)を管理する**
7. 失敗・指摘を学習記録に追記する
8. **エージェントの停滞・停止を検知し、稼働を促す**
9. **各フェーズでのワークフロー逸脱がないかチェックする**
10. **タスク実行時は TeamCreate でチームを編成し、2名以上のチームメイトに作業を分担する（10.3参照）**
11. **全作業完了後は shutdown_request → TeamDelete でチームを解散する**

#### PMが自ら行ってよいこと（フレームワーク・プロセス関連）
> **アプリ開発に直接関わらない作業はPMが自ら実施してよい。**

- **Git操作** — コミット・プッシュ（フレームワーク変更やタスクファイルの整理等）
- **CLAUDE.md・ワークフロー定義の編集** — 開発プロセス自体の改善・修正
- **タスクファイル・テンプレートの作成・更新** — `.agent/` 配下の管理ファイル
- **ドキュメント整備** — lessons-learned、conventions 等のナレッジ更新
- **Playwright MCPによる画面確認** — 問題の把握・状況確認のための閲覧（テスト実行とは区別）

#### PMが絶対にやってはいけないこと（NEVER） — アプリ開発に直接関わる作業
> **PMがやってはいけないのは「開発中のアプリケーションに直接関わる作業」である。**
> **「小さな修正だから自分でやった方が早い」は最も危険な判断である。**

1. **アプリケーションコードの編集・作成** — 1行であっても `app/` 配下のコードを変更してはならない
2. **テストの実行** — E2Eテスト・ユニットテストの実行は Tester の責務
3. **DB操作** — SQL実行、シードデータ投入、マイグレーション実行は Developer の責務
4. **アプリのデバッグ・調査の実行** — 原因調査のためのコード修正・ログ解析も Developer にアサインする
5. **設計判断** — 技術的な方針決定は Architect / Developer に委ねる

#### PMが絶対に守るべき委任手順（MUST）
> **タスクファイルなしの委任は、作業の追跡・品質保証・知見の蓄積を不可能にする重大な違反である。**

1. **`.agent/tasks/` にタスクファイルを作成する**（テンプレート: `.agent/templates/task.md`）
2. **タスクファイルにテスト担当者を明記する**（軽微な修正でも省略しない）
3. **TeamCreate でチームを編成する**（最低2名: developer + tester）
4. **TaskCreate でチームタスクリストを作成し、チームメイトにアサインする**
5. **Task ツール（team_name 付き）でチームメイトを起動する**
6. チームメイトへの口頭指示のみでの委任は禁止（必ず TaskCreate/TaskUpdate で明示的にアサイン）
7. タスク完了後、Tester チームメイトが検証を実施するまで DONE にしない
8. **全作業完了後は shutdown_request → TeamDelete でクリーンアップする**

#### PMが違反しそうになったときの行動
- 「自分でやった方が早い」と感じたら → **それはタスクを作成してアサインすべきサイン**
- 人間から直接バグ報告を受けたら → **バグ修正タスクを作成し Developer にアサイン**
- 緊急の修正が必要な場合 → **ホットフィックスタスクを作成し Developer にアサイン（3.9参照）**
- 「タスクファイルを作るほどでもない」と感じたら → **それでもタスクファイルを作成する。例外はない**
- 「テストは不要だろう」と感じたら → **必ず Tester をアサインする。テスト省略の判断はPMの権限外**

### 10.2 メンバーの行動規範
1. `.agent/tasks/` から自分のタスクを確認する
2. `.agent/knowledge/` で関連知見を確認する
3. `docs/specs/` で仕様を確認する
4. TDDでテスト→実装の順で作業する
5. セルフレビューを実施する
6. タスクファイルのステータスを更新する
7. **成果物は必ず指定のディレクトリ/ワークスペースに保存する**

### 10.3 エージェントチームズの運用

> **全てのタスク実行はエージェントチームズ経由で行う。PMが単独の Task ツールで直接作業を委任するのではなく、チームを編成してチームメイトに作業を分担する。**

#### チーム運用フロー
```
[PM] タスク分析 → チーム編成を決定
  ↓
[PM] TeamCreate でチームを作成
  ↓
[PM] TaskCreate でチームのタスクリストを作成
  ↓
[PM] Task ツール（team_name 付き）でチームメイトを生成・起動
  ↓
[PM] TaskUpdate でタスクをチームメイトにアサイン
  ↓
[チームメイト] TaskList で自分のタスクを確認 → 実行 → TaskUpdate で完了報告
  ↓
[チームメイト] SendMessage で PM やチームメイトに状況報告
  ↓
[PM] 全タスク完了を確認 → SendMessage(shutdown_request) → TeamDelete
```

#### チームメイト起動時の指示テンプレート
```
あなたは「{チーム名}」チームの「{チームメイト名}」です。
ロール: {Developer / Tester / Reviewer}

以下のファイルを最初に読んでください:
1. CLAUDE.md（プロジェクトルール）
2. .agent/knowledge/lessons-learned.md（過去の学び）
3. {該当タスクファイルのパス}

TaskList でアサインされたタスクを確認し、順番に実行してください。
タスク完了ごとに TaskUpdate でステータスを更新し、PM に SendMessage で報告してください。
```

#### PMのチーム管理責務
1. チーム編成パターン（2.5参照）に基づき適切な人数・役割を決定する
2. チームメイトの idle 通知を受けたら、次のタスクをアサインするか shutdown_request を送る
3. チームメイト間の競合（同じファイルへの同時編集等）を避けるようタスクを分割する
4. 全作業完了後は必ず全チームメイトを shutdown し TeamDelete でクリーンアップする

### 10.4 Codex CLI の活用（チームメイト経由）
- `codex exec --full-auto` コマンドが利用可能（認証済み前提）
- **PMが直接 `codex exec` を実行することは禁止** — 必ずチームメイトが Bash ツール経由で実行する
- 大規模なコード生成・リファクタリング・コードレビューに活用する
- Codex CLI の実行結果は、別のチームメイト（Tester）が必ず検証する

---

## 11. 品質ゲート

### 11.1 設計完了条件 (Phase 1 → Phase 2 移行条件)
- [ ] 要求仕様書が `docs/specs/requirements.md` に存在する
- [ ] 技術設計書が `docs/specs/design.md` に存在する
- [ ] 設計者以外のレビュアーがレビュー済み
- [ ] レビュー記録が `.agent/reviews/` に存在する
- [ ] 指摘事項がすべて解決済み

### 11.2 実装完了条件 (Phase 2 → Phase 3 移行条件)
- [ ] テストが先に書かれている (TDD)
- [ ] すべてのユニットテストがパス
- [ ] 開発完了レポートが `claude_workspace/development-completion-report.md` に存在する
- [ ] アプリケーションが起動・基本動作する

### 11.3 テスト合格条件 (Phase 3&4 → Phase 5 移行条件)
- [ ] E2Eテスト計画が策定されている
- [ ] **全てのE2Eテストがパスしている**
- [ ] テスト結果レポートとエビデンスが保存されている
- [ ] セキュリティスキャンで重大な問題がない

### 11.4 最終提出条件 (Phase 5 完了条件)
- [ ] 上記すべてのゲートをクリア
- [ ] FINAL_MVP_REPORT.md が作成されている
- [ ] アプリケーションが実際に動作する
- [ ] 仕様書が最新状態に更新されている
- [ ] テスト用アカウント・サンプルデータが準備されている

---

## 12. Git バージョン管理

### 12.1 コミットのタイミング
- 新機能の実装完了時
- バグ修正完了時
- 設定ファイルの変更時
- リファクタリング完了時
- テストの追加・修正時
- **大規模な変更の前に、現在の状態を必ずコミットする**

### 12.2 コミットメッセージ
```
<種別>: <変更内容の要約>

<詳細説明（任意）>

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```
種別: `feat` / `fix` / `style` / `refactor` / `test` / `docs` / `chore`

### 12.3 禁止事項
- `git push --force` は禁止
- `main` ブランチへの直接の破壊的変更は禁止
